---
import Layout from '../../layouts/Layout.astro';
import InfoVelas from '../../components/InfoVelas.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';

// En desarrollo: usar prerender=false para SSR (permite cualquier slug)
// En build: generar placeholder para modo estático
export const prerender = import.meta.env.DEV ? false : undefined;

export async function getStaticPaths() {
  // En desarrollo: retornar [] permite SSR para cualquier slug
  // En build: retornar placeholder genera /productos/placeholder.html
  if (import.meta.env.DEV) {
    return [];
  }
  // En build: generar placeholder para modo estático
  return [{ params: { slug: 'placeholder' } }];
}
---

<Layout>
  <div class="pagina-producto">
    <div id="breadcrumb-container"></div>

    <!-- Producto Grid -->
    <section class="producto-grid">
      <div class="container">
        <div id="product-detail-container" class="product-detail-container">
          <!-- El producto se cargará dinámicamente aquí -->
        </div>
      </div>
    </section>

    <InfoVelas />
  </div>

  <script is:inline>
    // Extraer slug directamente de la URL (funciona en modo estático)
    function getSlug() {
      const pathname = window.location.pathname;
      const match = pathname.match(/\/(productos|souvenirs|navidad|promos)\/([^\/]+)/);
      if (match && match[2]) {
        return decodeURIComponent(match[2]);
      }
      return null;
    }
    
    // Cargar el script de detalle de producto
    (function() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDetail);
      } else {
        initDetail();
      }
      
      function initDetail() {
        const productSlug = getSlug();
        
        if (!productSlug) {
          console.error('No se pudo obtener el slug del producto');
          return;
        }
        
        // Cargar el script si no está cargado
        if (!window.initProductDetail) {
          const script = document.createElement('script');
          script.src = '/js/product-detail.js?v=2.1.4-2026-01-03T14-11-34';
          script.onload = function() {
            if (window.initProductDetail) {
              window.initProductDetail(productSlug, {
                containerSelector: '#product-detail-container',
                autoLoad: true
              }).then(() => {
                updateBreadcrumb();
              });
            }
          };
          document.body.appendChild(script);
        } else {
          window.initProductDetail(productSlug, {
            containerSelector: '#product-detail-container',
            autoLoad: true
          }).then(() => {
            updateBreadcrumb();
          });
        }
      }
      
      function updateBreadcrumb() {
        const container = document.getElementById('breadcrumb-container');
        const productContainer = document.getElementById('product-detail-container');
        
        if (container && productContainer) {
          const h1 = productContainer.querySelector('h1');
          const categoria = window.location.pathname.includes('/productos/') ? 'productos' :
                           window.location.pathname.includes('/souvenirs/') ? 'souvenirs' :
                           window.location.pathname.includes('/navidad/') ? 'navidad' : 'productos';
          
          const productName = h1 ? h1.textContent : 'Producto';
          
          container.innerHTML = `
            <div class="breadcrumb">
              <div class="container">
                <a href="/">Inicio</a>
                <span class="separator">/</span>
                <a href="/${categoria}">${categoria.charAt(0).toUpperCase() + categoria.slice(1)}</a>
                <span class="separator">/</span>
                <span class="current">${productName}</span>
              </div>
            </div>
          `;
        }
      }
    })();
  </script>
</Layout>
