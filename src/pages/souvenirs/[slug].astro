---
import Layout from '../../layouts/Layout.astro';
import InfoVelas from '../../components/InfoVelas.astro';

// En desarrollo: usar prerender=false para SSR (permite cualquier slug)
// En build: generar placeholder para modo estático
export const prerender = import.meta.env.DEV ? false : undefined;

export async function getStaticPaths() {
  // En desarrollo: retornar [] permite SSR para cualquier slug
  // En build: retornar placeholder genera /souvenirs/placeholder.html
  if (import.meta.env.DEV) {
    return [];
  }
  // En build: generar placeholder para modo estático
  return [{ params: { slug: 'placeholder' } }];
}
---

<Layout>
  <div class="pagina-producto">
    <div id="breadcrumb-container"></div>

    <section class="producto-grid">
      <div class="container">
        <div id="product-detail-container" class="product-detail-container">
          <!-- El producto se cargará dinámicamente aquí -->
        </div>
      </div>
    </section>

    <InfoVelas />
  </div>

  <script is:inline>
    // Extraer slug directamente de la URL (funciona en modo estático)
    function getSlug() {
      const pathname = window.location.pathname;
      const match = pathname.match(/\/(productos|souvenirs|navidad)\/([^\/]+)/);
      if (match && match[2]) {
        return decodeURIComponent(match[2]);
      }
      return null;
    }
    
    (function() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDetail);
      } else {
        initDetail();
      }
      
      function initDetail() {
        const productSlug = getSlug();
        
        if (!productSlug) {
          console.error('No se pudo obtener el slug del producto');
          return;
        }
        
        if (window.initProductDetail) {
          window.initProductDetail(productSlug, {
            containerSelector: '#product-detail-container',
            autoLoad: true
          }).then(() => {
            updateBreadcrumb();
          });
        } else {
          setTimeout(initDetail, 100);
        }
      }
      
      function updateBreadcrumb() {
        const container = document.getElementById('breadcrumb-container');
        const productContainer = document.getElementById('product-detail-container');
        
        if (container && productContainer) {
          const h1 = productContainer.querySelector('h1');
          const productName = h1 ? h1.textContent : 'Souvenir';
          
          container.innerHTML = `
            <div class="breadcrumb">
              <div class="container">
                <a href="/">Inicio</a>
                <span class="separator">/</span>
                <a href="/souvenirs">Souvenirs</a>
                <span class="separator">/</span>
                <span class="current">${productName}</span>
              </div>
            </div>
          `;
        }
      }
    })();
  </script>
</Layout>
