---
// Links est√°ticos que siempre aparecen (en orden)
const staticLinksBefore = [
  { href: '/', text: 'Inicio' },
];

// Galer√≠a: nombre y href se actualizan con /api/gallery-info.php
const staticLinksAfter = [
  { href: '/galeria', text: 'Galeria de Ideas', id: 'nav-gallery-link' },
];
---

<nav>
  <div class="nav-container">
    <!-- Izquierda: logo -->
    <a href="/" class="logo" id="nav-logo">
      <img src="/images/lume-logo.png" alt="Logo" width="120" height="60" id="nav-logo-img" loading="eager" decoding="async" />
    </a>
 <!-- Centro: men√∫ hamburguesa (solo mobile) -->
    <button id="menu-toggle" class="menu-toggle" aria-label="Abrir men√∫">
      ‚ò∞
    </button>

    <!-- Derecha: solo en desktop (links + carrito) -->
    <div class="nav-desktop-right">
      <ul class="nav-links desktop" id="nav-links-desktop">
        {staticLinksBefore.map((link) => (
          <li><a href={link.href}>{link.text}</a></li>
        ))}
        <!-- Las categor√≠as se cargar√°n din√°micamente aqu√≠ -->
        {staticLinksAfter.map((link) => (
          <li><a href={link.href} id={link.id || undefined}>{link.text}</a></li>
        ))}
      </ul>

      <a href="/wishlist" class="wishlist-icon desktop-wishlist" title="Mis Favoritos">
        ‚ù§Ô∏è <span id="wishlist-count" style="display: none;">0</span>
      </a>
      <a href="/carrito" class="carrito-icon desktop-cart">
        üõí <span id="cart-count" style="display: none;">0</span>
      </a>
    </div>

    <!-- Wishlist y Carrito en mobile (separado) -->
    <div class="mobile-icons">
      <a href="/wishlist" class="wishlist-icon mobile-wishlist" title="Mis Favoritos">
        ‚ù§Ô∏è <span id="wishlist-count-mobile" style="display: none;">0</span>
      </a>
      <a href="/carrito" class="carrito-icon mobile-cart">
        üõí <span id="cart-count-mobile" style="display: none;">0</span>
      </a>
    </div>
  </div>

  <!-- Men√∫ desplegable en mobile -->
  <ul id="nav-links" class="nav-links mobile">
    {staticLinksBefore.map((link) => (
      <li><a href={link.href}>{link.text}</a></li>
    ))}
    <!-- Las categor√≠as se cargar√°n din√°micamente aqu√≠ -->
    {staticLinksAfter.map((link) => (
      <li><a href={link.href} id={link.id ? 'nav-gallery-link-mobile' : undefined}>{link.text}</a></li>
    ))}
  </ul>
</nav>

<script is:inline>
  // Cargar contadores desde cache inmediatamente para evitar flash
  (function() {
    // Cargar wishlist count desde localStorage
    const cachedWishlistCount = localStorage.getItem('wishlist_count');
    if (cachedWishlistCount !== null) {
      const count = parseInt(cachedWishlistCount, 10);
      const countElements = document.querySelectorAll('#wishlist-count, #wishlist-count-mobile');
      countElements.forEach(el => {
        el.textContent = count;
        el.style.display = count > 0 ? 'block' : 'none';
      });
    } else {
      // Si no hay cache, ocultar desde el inicio
      const countElements = document.querySelectorAll('#wishlist-count, #wishlist-count-mobile');
      countElements.forEach(el => {
        el.style.display = 'none';
      });
    }
    
    // Cargar cart count desde localStorage
    const cachedCartCount = localStorage.getItem('cart_count');
    if (cachedCartCount !== null) {
      const count = parseInt(cachedCartCount, 10);
      const countElements = document.querySelectorAll('#cart-count, #cart-count-mobile');
      countElements.forEach(el => {
        el.textContent = count;
        el.style.display = count > 0 ? 'block' : 'none';
      });
    } else {
      // Si no hay cache, ocultar desde el inicio
      const countElements = document.querySelectorAll('#cart-count, #cart-count-mobile');
      countElements.forEach(el => {
        el.style.display = 'none';
      });
    }
  })();
  
  // Cargar configuraci√≥n de la tienda (logo, etc.) - Usar cache para evitar flash
  (function loadShopSettings() {
    // Intentar cargar desde cache primero
    const cachedShop = localStorage.getItem('shop_settings');
    let shopData = null;
    
    if (cachedShop) {
      try {
        const parsed = JSON.parse(cachedShop);
        if (parsed.timestamp && Date.now() - parsed.timestamp < 5 * 60 * 1000) {
          shopData = parsed.data;
        }
      } catch(e) {}
    }
    
    // Aplicar logo inmediatamente si est√° en cache
    if (shopData && shopData.shop_logo) {
      const logoImg = document.getElementById('nav-logo-img');
      const logoLink = document.getElementById('nav-logo');
      if (logoImg) {
        logoImg.src = shopData.shop_logo;
        logoImg.alt = shopData.shop_name || 'Logo';
      }
      if (logoLink && shopData.shop_name) {
        logoLink.title = shopData.shop_name;
      }
    }
    
    // Cargar datos frescos en segundo plano
    (async function() {
      try {
        const response = await fetch('/api/shop.php');
        const data = await response.json();
        
        if (data.success && data.shop) {
          const shop = data.shop;
          
          // Actualizar cache
          localStorage.setItem('shop_settings', JSON.stringify({
            timestamp: Date.now(),
            data: shop
          }));
          
          // Actualizar logo del navbar
          if (shop.shop_logo) {
            const logoImg = document.getElementById('nav-logo-img');
            const logoLink = document.getElementById('nav-logo');
            if (logoImg) {
              logoImg.src = shop.shop_logo;
              logoImg.alt = shop.shop_name || 'Logo';
            }
            if (logoLink && shop.shop_name) {
              logoLink.title = shop.shop_name;
            }
          }
        }
      } catch (error) {
        console.error('Error al cargar configuraci√≥n de la tienda:', error);
      }
    })();
  })();
  
  // Galer√≠a: actualizar nombre y enlace desde gallery_info
  (function() {
    fetch('/api/gallery-info.php')
      .then(r => r.json())
      .then(data => {
        if (data.success && data.name && data.slug) {
          const href = '/' + data.slug.replace(/^\//, '');
          const desktopLink = document.getElementById('nav-gallery-link');
          const mobileLink = document.getElementById('nav-gallery-link-mobile');
          if (desktopLink) {
            desktopLink.href = href;
            desktopLink.textContent = data.name;
          }
          if (mobileLink) {
            mobileLink.href = href;
            mobileLink.textContent = data.name;
          }
        }
      })
      .catch(() => {});
  })();
  
  // Cargar categor√≠as din√°micamente (solo una vez)
  (function() {
    let categoriesLoaded = false;
    const CATEGORIES_MARKER = 'data-categories-loaded';
    const CATEGORIES_CACHE_KEY = 'navbar_categories';
    const CACHE_TIME = 5 * 60 * 1000; // 5 minutos
    
    // Funci√≥n para insertar categor√≠as en el DOM
    function insertCategories(categoryLinks, desktopLinks, mobileLinks) {
      if (!categoryLinks || categoryLinks.length === 0) return;
      
      // Insertar en desktop
      if (desktopLinks) {
        const allLinks = Array.from(desktopLinks.querySelectorAll('li'));
        if (allLinks.length >= 2 && !desktopLinks.hasAttribute(CATEGORIES_MARKER)) {
          const galeriaLink = allLinks[1];
          categoryLinks.forEach(link => {
            // Verificar si el link ya existe
            const existingLink = Array.from(desktopLinks.querySelectorAll('a')).find(a => a.href.endsWith(link.href));
            if (!existingLink) {
              const li = document.createElement('li');
              li.setAttribute('data-category-link', 'true');
              const a = document.createElement('a');
              a.href = link.href;
              a.textContent = link.text;
              li.appendChild(a);
              desktopLinks.insertBefore(li, galeriaLink);
            }
          });
          desktopLinks.setAttribute(CATEGORIES_MARKER, 'true');
        }
      }
      
      // Insertar en mobile
      if (mobileLinks) {
        const allMobileLinks = Array.from(mobileLinks.querySelectorAll('li'));
        if (allMobileLinks.length >= 2 && !mobileLinks.hasAttribute(CATEGORIES_MARKER)) {
          const galeriaMobileLink = allMobileLinks[1];
          categoryLinks.forEach(link => {
            // Verificar si el link ya existe
            const existingLink = Array.from(mobileLinks.querySelectorAll('a')).find(a => a.href.endsWith(link.href));
            if (!existingLink) {
              const li = document.createElement('li');
              li.setAttribute('data-category-link', 'true');
              const a = document.createElement('a');
              a.href = link.href;
              a.textContent = link.text;
              li.appendChild(a);
              mobileLinks.insertBefore(li, galeriaMobileLink);
            }
          });
          mobileLinks.setAttribute(CATEGORIES_MARKER, 'true');
        }
      }
    }
    
    async function loadCategories() {
      // Verificar si ya est√°n cargadas usando un marcador en el DOM
      const desktopLinks = document.getElementById('nav-links-desktop');
      const mobileLinks = document.getElementById('nav-links');
      
      if (desktopLinks && desktopLinks.hasAttribute(CATEGORIES_MARKER)) {
        categoriesLoaded = true;
        return;
      }
      
      if (mobileLinks && mobileLinks.hasAttribute(CATEGORIES_MARKER)) {
        categoriesLoaded = true;
        return;
      }
      
      // Cargar desde cache primero (inmediatamente, sin esperar)
      const cachedCategories = localStorage.getItem(CATEGORIES_CACHE_KEY);
      if (cachedCategories) {
        try {
          const parsed = JSON.parse(cachedCategories);
          if (parsed.timestamp && Date.now() - parsed.timestamp < CACHE_TIME && parsed.data) {
            // Insertar categor√≠as inmediatamente desde cache
            insertCategories(parsed.data, desktopLinks, mobileLinks);
            categoriesLoaded = true;
          }
        } catch(e) {}
      }
      
      // Evitar recargar si ya est√°n cargadas
      if (categoriesLoaded) {
        // Cargar datos frescos en segundo plano
        fetch('/api/categories.php')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.categories) {
              const categoryLinks = data.categories.map(cat => ({
                href: `/${cat.slug}`,
                text: cat.name
              }));
              localStorage.setItem(CATEGORIES_CACHE_KEY, JSON.stringify({
                timestamp: Date.now(),
                data: categoryLinks
              }));
            }
          })
          .catch(() => {});
        return;
      }
      
      // Cargar desde API
      try {
        const response = await fetch('/api/categories.php');
        const data = await response.json();
        
        if (data.success && data.categories) {
          // Crear links de categor√≠as
          const categoryLinks = data.categories.map(cat => ({
            href: `/${cat.slug}`,
            text: cat.name
          }));
          
          // Guardar en cache
          localStorage.setItem(CATEGORIES_CACHE_KEY, JSON.stringify({
            timestamp: Date.now(),
            data: categoryLinks
          }));
          
          // Insertar categor√≠as en el DOM
          insertCategories(categoryLinks, desktopLinks, mobileLinks);
          
          categoriesLoaded = true;
        }
      } catch (error) {
        console.error('Error al cargar categor√≠as:', error);
      }
    }
    
    // Cargar categor√≠as inmediatamente (antes de DOMContentLoaded si es posible)
    // Esto evita el parpadeo al hacer clic
    loadCategories();
    
    // Tambi√©n cargar cuando el DOM est√© listo (por si acaso)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        initMenuToggle();
      });
    } else {
      initMenuToggle();
    }
    
    function initMenuToggle() {
      const toggle = document.getElementById('menu-toggle');
      const navLinks = document.getElementById('nav-links');

      if (toggle && navLinks) {
        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          navLinks.classList.toggle('open');
        });

        document.addEventListener('click', (e) => {
          if (navLinks.classList.contains('open') && !navLinks.contains(e.target) && e.target.id !== 'menu-toggle') {
            navLinks.classList.remove('open');
          }
        });
      }
    }
  })();
</script>
<style is:global>
  nav {
    background-color: #fff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .nav-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.6rem 2rem;
    position: relative;
  }

  .logo img {
    height: 40px;
    width: auto;
    max-width: 200px;
    object-fit: contain;
    display: block;
  }

  .menu-toggle {
    font-size: 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    display: none;
  }

  .carrito-icon,
  .wishlist-icon {
    position: relative;
    font-size: 1.4rem;
    text-decoration: none;
    color: #333;
  }

  .nav-desktop-right .wishlist-icon,
  .nav-desktop-right .carrito-icon {
    margin-left: 1rem;
  }

  .mobile-icons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

   #cart-count,
  #cart-count-mobile,
  #wishlist-count,
  #wishlist-count-mobile {
    background: var(--primary);
    color: white;
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 50%;
    position: absolute;
    top: -10px;
    right: -12px;
  }
  ul.nav-links {
    list-style: none;
    gap: 1rem;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
  }

  ul.nav-links li {
    /* No necesita display: list-item cuando el padre es flex */
    margin: 0;
    padding: 0;
  }

  ul.nav-links li a {
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: color 0.3s;
    display: block;
  }

  ul.nav-links li a:hover {
    color: var(--primary);
  }

  /* MOBILE */
  @media (max-width: 767px) {
    .logo img {
      max-width: 120px;
    }
    
    .menu-toggle {
      display: block;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .nav-desktop-right {
      display: none;
    }

    .desktop-cart {
      display: none;
    }

    .mobile-cart,
    .mobile-wishlist {
      display: block;
    }

    .desktop-wishlist,
    .desktop-cart {
      display: none !important;
    }

    .nav-links.desktop {
      display: none !important;
    }

    .nav-links.mobile {
      display: none;
      flex-direction: column;
      padding: 1rem 2rem;
      background: white;
      border: 1px solid #eee;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      z-index: 1001;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .nav-links.mobile.open {
      display: flex;
    }

    .nav-links.mobile li {
      margin-bottom: 0.5rem;
    }

    ul.nav-links li {
      width: 100%;
    }

    ul.nav-links li a {
      display: block;
      width: 100%;
      padding: 0.75rem 1rem;
      text-align: center;
    }
  }

  /* DESKTOP */
  @media (min-width: 768px) {
    .menu-toggle {
      display: none;
    }

    .nav-container {
      justify-content: space-between;
    }

    .nav-desktop-right {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .nav-links.desktop {
      display: flex;
      gap: 2rem;
    }

    .nav-links.mobile,
    .mobile-cart,
    .mobile-wishlist,
    .mobile-icons {
      display: none !important;
    }
  }
</style>
